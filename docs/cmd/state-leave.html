<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
	<meta property="og:url" content="/watchman/docs/cmd/state-leave.html" />
	<meta property="og:site_name" content="Watchman"/>
	<meta property="og:title" content="state-leave" />
	<meta property="og:image" content="/watchman/static/og_image.png" />
	<meta property="og:description" content="Since 4.4" />

  <link rel="stylesheet" type="text/css" media="screen" href="/watchman/css/main.css">
  
  <link rel="icon" href="static/favicon.png" type="image/x-icon">
  
  <base href="/watchman/" />
  
  <script async defer src="//cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react-with-addons.min.js"></script>
  <script async defer src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>

  <title>state-leave</title>
  <meta name="description" content="Since 4.4">

  <link rel="canonical" href="/watchman/docs/cmd/state-leave.html">
  <link rel="alternate" type="application/rss+xml" title="Watchman" href="/watchman/feed.xml" />
</head>

  <body>    
    <div id="fixed_header" class="fixedHeaderContainer visible">
  <header>
    <a href="/watchman/"><img src="/watchman/static/logo.png" /><h2>Watchman</h2></a>
    <div class="navigationWrapper navigationFull" id="flat_nav">
      <nav class="navigation">
        <ul>
          
          <li class="navItem navItemActive">
            <a href=docs/install.html>Docs</a>
          </li>
          
          <li class="navItem ">
            <a href=support.html>Support</a>
          </li>
          
          <li class="navItem ">
            <a href=http://github.com/facebook/watchman>GitHub</a>
          </li>
          
        </ul>
      </nav>
    </div>
    <div class="navigationWrapper navigationSlider" id="navigation_wrap"></div>
  </header>
  <script>
    var event = document.createEvent('Event');
    event.initEvent('slide', true, true);
    document.addEventListener('slide', function (e) {
      document.body.classList.toggle('sliderActive');
    }, false);
    var navData = [
      
      {
        href       : "docs/install.html",
        text       : "Docs",
      },
      
      {
        href       : "support.html",
        text       : "Support",
      },
      
      {
        href       : "http://github.com/facebook/watchman",
        text       : "GitHub",
      },
      
    ];
  </script>
  <script type="text/javascript">  
  window.addEventListener('load', function() {
    var Nav = React.createClass({displayName: "Nav",
      getInitialState: function() {
        return {
          currentPath: window.location.pathname,
          slideoutActive: false,
        };
      },
      getDefaultProps: function() {
        return {
          data: navData,
        }
      },
      handleClick: function(id) {
        this.setState({
          slideoutActive: false,
        });
        document.dispatchEvent(event);
      },
      handleSlide: function(id) {
        this.setState({
          slideoutActive: !this.state.slideoutActive,
        });
        document.dispatchEvent(event);
      },
      render: function() {
        var classes = React.addons.classSet({
          'navSlideout': true,
          'navSlideoutActive': this.state.slideoutActive,
        });
        var navClasses = React.addons.classSet({
          'slidingNav': true,
          'slidingNavActive': this.state.slideoutActive,
        });
        return (
          React.createElement("div", null, 
            React.createElement("div", {className: classes, onClick: this.handleSlide}, 
              React.createElement("i", {className: "fa fa-bars"})
            ), 
            React.createElement("nav", {className: navClasses}, 
              React.createElement("ul", null, 
                this.props.data.map(this.renderNavItems)
              )
            )
          )
        );
      },
      renderNavItems: function(child, index) {
        var classes = React.addons.classSet({
          'navItem': true,
          'navItemActive': this.state.currentPath === child.href,
        });
        return (
          React.createElement("li", {key: index, className: classes}, 
            React.createElement("a", {onClick: this.handleClick, href: child.href}, child.text)
          )
        );
      },
    });

    function render(navData) {
      React.render(
        React.createElement(Nav, {data: navData}),
        document.getElementById('navigation_wrap')
      );
    }
    render(navData);
  });
  </script>
</div>

    <div class="navPusher">
      <div class="mainContainer blogContainer postContainer">
  <div id="main_wrap" class="wrapper mainWrapper">
    <div>
</div>
<nav class='toc' id="doc_nav"></nav>
<script>
  var docnavData = [
    
    {
      group     : "Installation",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
    {
      group     : "Invocation",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
    {
      group     : "Compatibility",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
    {
      group     : "Commands",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
    {
      group     : "Queries",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
    {
      group     : "Expression Terms",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
    {
      group     : "Internals",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        },
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
    {
      group     : "Troubleshooting",
      items     : [
        
        
        {
          key : "/watchman",
          title : "",
          url : "/watchman",
        }
        
      ],
    },
    
  ];
</script>
<script type="text/javascript">  
window.addEventListener('load', function() {
  var DocNav = React.createClass({displayName: "DocNav",
    getInitialState: function() {
      return {
        toggleActive: false,
      };
    },
    getDefaultProps: function() {
      return {
        currentDoc: "state-leave",
        currentGroup: "Commands",
        data: docnavData,
      }
    },
    handleSlide: function(id) {
      this.setState({
        toggleActive: !this.state.toggleActive,
      });
    },
    render: function() {
      var classes = React.addons.classSet({
        'navToggle': true,
        'navToggleActive': this.state.toggleActive,
      });
      var navClasses = React.addons.classSet({
        'toggleNav': true,
        'toggleNavActive': this.state.toggleActive,
      });
      return (
        React.createElement("div", {className: navClasses}, 
          React.createElement("section", null, 
            this.props.data.map(this.renderNavGroups)
          ), 
          React.createElement("div", {className: classes, onClick: this.handleSlide}, React.createElement("i", {className: "fa fa-chevron-circle-down"}))
        )
      );
    },
    renderNavGroups: function(child, index) {
      var classes = React.addons.classSet({
        'navGroup': true,
        'navGroupActive': this.props.currentGroup === child.group,
      });
      return (
        React.createElement("div", {className: classes, key: index}, 
          React.createElement("h3", null, child.group), 
          React.createElement("ul", null, 
            child.items.map(this.renderNavItems)
          )
        )
      );
    },
    renderNavItems: function(child, index) {
      var itemClasses = React.addons.classSet({
        'navListItem': true,
        'navListItemActive': this.props.currentDoc === child.title,
      });
      var classes = React.addons.classSet({
        'navItem': true,
        'navItemActive': this.props.currentDoc === child.title,
      });
      return (
        React.createElement("li", {className: itemClasses, key: index}, React.createElement("a", {className: classes, href: child.url},  child.title))
      );
    },
  });

  function docNavRender(docnavData) {
    React.render(
      React.createElement(DocNav, {data: docnavData}),
      document.getElementById('doc_nav')
    );
  }
  docNavRender(docnavData);
});
</script>

    <div class="post">
  <header class="post-header">
    <h1 class="post-title">state-leave</h1>
  </header>

  <article class="post-content">
   
      <p><em>Since 4.4</em></p>

<p>The <code>state-leave</code> command works in conjunction with
<a href="/watchman/docs/cmd/state-enter.html">state-enter</a> to facilitate <a href="/watchman/docs/cmd/subscribe.html#advanced-settling">advanced
settling in subscriptions</a>.</p>

<p><code>state-leave</code> causes a watch to no longer be marked as being in a particular
named state.</p>

<h3 id="examples">Examples</h3>

<p>This is the simplest example, vacating a state named <code>mystate</code>:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[</span><span class="s2">&quot;state-leave&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/root&quot;</span><span class="p">,</span> <span class="s2">&quot;mystate&quot;</span><span class="p">]</span>
</code></pre></div>
<p>It will cause any subscribers to receive a unilateral subscription PDU from the
watchman server:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;subscription&quot;</span><span class="p">:</span>  <span class="s2">&quot;mysubscriptionname&quot;</span><span class="p">,</span>
  <span class="nt">&quot;root&quot;</span><span class="p">:</span>          <span class="s2">&quot;/path/to/root&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state-leave&quot;</span><span class="p">:</span>   <span class="s2">&quot;mystate&quot;</span><span class="p">,</span>
  <span class="nt">&quot;clock&quot;</span><span class="p">:</span>         <span class="s2">&quot;c:1446410081:18462:7:135&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>clock</code> field in the response is the (synchronized; see below) clock at the
time that the state was entered and can be used in subsequent queries, in
combination with the corresponding <code>state-enter</code> subscription PDU clock, to
locate things that changed while the state was asserted.</p>

<p>A more complex example demonstrates passing metadata to any subscribers.  The
<code>metadata</code> field is propagated through to the subscribers and is not
interpreted by the watchman server.  It can be any JSON value.</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[</span><span class="s2">&quot;state-leave&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/root&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mystate&quot;</span><span class="p">,</span>
  <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
  <span class="p">}</span>
<span class="p">}]</span>
</code></pre></div>
<p>This will emit the following unilateral subscription PDU to all subscribers:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;subscription&quot;</span><span class="p">:</span>  <span class="s2">&quot;mysubscriptionname&quot;</span><span class="p">,</span>
  <span class="nt">&quot;root&quot;</span><span class="p">:</span>          <span class="s2">&quot;/path/to/root&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state-leave&quot;</span><span class="p">:</span>   <span class="s2">&quot;mystate&quot;</span><span class="p">,</span>
  <span class="nt">&quot;clock&quot;</span><span class="p">:</span>         <span class="s2">&quot;c:1446410081:18462:7:137&quot;</span><span class="p">,</span>
  <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="abandoned-state">Abandoned State</h3>

<p>A state is implicitly vacated when the watchman client session that asserted it
disconnects.  This helps to avoid breaking subscribers (since the typical
action is to defer or drop notifications) if the tooling that initiated the
state terminates unexpectedly.</p>

<p>An abandoned state is reported to any subscribers via a unilateral subscription
PDU with the <code>abandoned</code> field set to <code>true</code>:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;subscription&quot;</span><span class="p">:</span>  <span class="s2">&quot;mysubscriptionname&quot;</span><span class="p">,</span>
  <span class="nt">&quot;root&quot;</span><span class="p">:</span>          <span class="s2">&quot;/path/to/root&quot;</span><span class="p">,</span>
  <span class="nt">&quot;state-leave&quot;</span><span class="p">:</span>   <span class="s2">&quot;mystate&quot;</span><span class="p">,</span>
  <span class="nt">&quot;clock&quot;</span><span class="p">:</span>         <span class="s2">&quot;c:1446410081:18462:7:137&quot;</span><span class="p">,</span>
  <span class="nt">&quot;abandoned&quot;</span><span class="p">:</span>     <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>
<p>This allows the subscriber to take an appropriate action.</p>

<h3 id="synchronization">Synchronization</h3>

<p>States are synchronized with the state of the filesystem so that it is
possible for subscribers to reason about when files changed with respect to
the state.</p>

<p>This means that issuing a <code>state-leave</code> command will <a href="/watchman/docs/cookies.html#how-cookies-work">perform query
synchronization</a> to ensure that
things are in sync.</p>

<p>The <code>state-leave</code> command will use a default <code>sync_timeout</code> of 60 seconds.
If the synchronization cookie is not observed within the configured
<code>sync_timeout</code>, an error will be returned and <em>the state will not be entered</em>.</p>

<p>In some cases, perhaps during the initial crawl of a very large tree, You may
specify an alternative value for the timeout; the value is expressed in
<em>milliseconds</em>:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[</span><span class="s2">&quot;state-leave&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/root&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mystate&quot;</span><span class="p">,</span>
  <span class="nt">&quot;sync_timeout&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
  <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
  <span class="p">}</span>
<span class="p">}]</span>
</code></pre></div>
<p>You may also specify <code>0</code> for the timeout to disable synchronization for this
particular command.   This may cause the state to appear to clients to have
been vacated logically before it actually did in the case that there are
buffered notifications that have not yet been processed by watchman at the time
that the state was vacated.</p>

    
  </article>
</div>

  </div>
</div>


      <div class="footerContainer">
  <div id="footer_wrap" class="wrapper footerWrapper">
    <section id="fb_oss" class="fbOpenSourceFooter">
      <a href="https://code.facebook.com/projects/" target="_blank"><img src="/watchman/static/oss_logo.png" alt="Facebook Open Source" title="Facebook Open Source" /></a>
    </section>
  </div>
</div>
<script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = window.location.href.replace(window.location.hash, '') + "#" + id;
    anchor.innerHTML = "<i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  window.addEventListener('load', function() {
    var contentBlock = document.getElementsByClassName("post")[0] || document.getElementsByClassName("news")[0];
    if (!contentBlock) {
      return;
    }
    for (var level = 1; level <= 6; level++) {
      linkifyAnchors(level, contentBlock);
    }
  });
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44373548-13', 'auto');
  ga('send', 'pageview');
</script>
<script>
  window.addEventListener('load', function() {
    hljs.initHighlightingOnLoad();

    // Async load some styles
    function loadStyle(href) {
      var s = document.createElement('link');
      s.setAttribute('rel', 'stylesheet');
      s.setAttribute('href', href);
      s.setAttribute('type', 'text/css');
      document.getElementsByTagName('head')[0].appendChild(s);
    }
    loadStyle("//nuclide.io/static/fonts/332720/BC699FA675F9356E3.css");
    loadStyle("//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css");
    loadStyle("//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css");
  });
</script>

    </div>
  </body>

</html>
