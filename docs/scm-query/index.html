<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus">


<title data-react-helmet="true">Source Control Aware Queries | Watchman</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Watchman"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" name="description" content="*Since 4.9.*"><meta data-react-helmet="true" property="og:description" content="*Since 4.9.*"><meta data-react-helmet="true" property="og:url" content="https://facebook.github.io/watchman//watchman/docs/scm-query">

<link data-react-helmet="true" rel="shortcut icon" href="/watchman/img/favicon.png">


<link rel="stylesheet" href="/watchman/styles.fee8cdf5.css">


<link rel="preload" href="/watchman/styles.edf81c23.js" as="script">

<link rel="preload" href="/watchman/runtime~main.8249b1c8.js" as="script">

<link rel="preload" href="/watchman/main.531fe527.js" as="script">

<link rel="preload" href="/watchman/1.8e55109d.js" as="script">

<link rel="preload" href="/watchman/2.474167d8.js" as="script">

<link rel="preload" href="/watchman/70.1fbfc70e.js" as="script">

<link rel="preload" href="/watchman/d6764f29.44a68f59.js" as="script">

<link rel="preload" href="/watchman/17896441.abd54760.js" as="script">

<link rel="preload" href="/watchman/20b3f033.7168216c.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/watchman/"><img class="navbar__logo" src="/watchman/img/logo.png" alt="Watchman Logo"><strong class="navbar__title">Watchman</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/watchman/docs/install">Docs</a><a class="navbar__item navbar__link" href="/watchman/docs/support">Support</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/watchman">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/watchman/"><img class="navbar__logo" src="/watchman/img/logo.png" alt="Watchman Logo"><strong class="navbar__title">Watchman</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/watchman/docs/install">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/support">Support</a></li><li class="menu__list-item"><a class="menu__link" target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/watchman">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="sidebarLogo_3ono"><img src="/watchman/img/logo.png" alt="Watchman Logo"><strong>Watchman</strong></div><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Installation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/install">Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/release-notes">Release Notes</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Invocation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/cli-options">Command Line</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watchman-make">watchman-make</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watchman-wait">watchman-wait</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watchman-replicate-subscription">watchman-replicate-subscription</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/cppclient">C++ Client</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/nodejs">NodeJS</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/config">Configuration Files</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/socket-interface">Socket Interface</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Compatibility</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/compatibility">Compatibility Rules</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/capabilities">Capabilities</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Commands</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/find">find</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/flush-subscriptions">flush-subscriptions</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/get-config">get-config</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/get-sockname">get-sockname</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/list-capabilities">list-capabilities</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/log">log</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/log-level">log-level</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/query">query</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/shutdown-server">shutdown-server</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/since">since</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/state-enter">state-enter</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/state-leave">state-leave</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/subscribe">subscribe</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/trigger">trigger</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/trigger-del">trigger-del</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/trigger-list">trigger-list</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/unsubscribe">unsubscribe</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/version">version</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watch">watch</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watch-del">watch-del</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watch-del-all">watch-del-all</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watch-list">watch-list</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/watch-project">watch-project</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Queries</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/clockspec">Clockspec</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/file-query">File Queries</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/simple-query">Simple Pattern Syntax</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/watchman/docs/scm-query">Source Control Aware Queries</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Expressions Terms</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/allof">allof</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/anyof">anyof</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/dirname">dirname &amp; idirname</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/empty">empty</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/exists">exists</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/match">match &amp; imatch</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/name">name &amp; iname</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/not">not</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/pcre">pcre &amp; ipcre</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/exp-since">since</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/size">size</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/suffix">suffix</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/type">type</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/bser">BSER Binary Protocol</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/casefolding">Case-Insensitivity</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/contributing">Contributing</a></li><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/cookies">Query Synchronization</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Troubleshooting</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/watchman/docs/troubleshooting">Troubleshooting</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Source Control Aware Queries</h1></header><div class="markdown"><p><em>Since 4.9.</em></p><p><em>The <a href="capabilities">capability</a> name associated with this
enhanced functionality is <code>scm-since</code>.</em></p><p>At the time of writing, only Mercurial is supported.  The capability name for
this is <code>scm-hg</code>.  The internal architecture allows supporting other source
control systems quite easily; it just needs someone to implement and test them!</p><p>A common pattern for tools that consume watchman is wanting to reason about
the changes in a version controlled repository.  For most repos it is fine
to simply receive information about all changed files as they are updated,
even during a rebase over several days of work by others.</p><p>For very large or very busy repositories, where a great many files can change
over a short period of time, it can be desirable to get a minimized set of
information about the changes.</p><p>For example, if your tool has the ability to load some pre-built data from
some artifact storage, rather than processing many hundreds of changed
files incrementally you may want to take the merge base of local changes
and use that to locate the pre-built data and process only the delta
between that state and the current state of the repo.</p><p>An illustration may help.  Here we see that a user has a stack of two commits
based off the symbolic <code>master</code> commit.  In this scenario, <code>master</code> is tracking
the tip of the repo to which the local repo is published, and the user is
checked out at the 6b38a5 commit:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">| @  6b38a5  wez</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| |  Add cats.cpp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| o  fa2e92  wez</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|/   Add cat.jpg</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">o f12345 master</span></div></code></pre></div><p>Now the user synchronizes their repo with the remote, fetching the commits but
not changing their work yet.   This is often combined with the step that follows,
but we are breaking it out here for the purposes of illustration.  This is
equivalent to running <code>hg pull</code> or <code>git fetch</code>:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">o  fabf87  coworker     master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.  Amazing new feature</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| @  6b38a5  wez</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| |  Add cats.cpp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| o  fa2e92  wez</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|/   Add cat.jpg</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">o</span></div></code></pre></div><p>The ellipsis portion of the DAG represents uninteresting commits to <code>wez</code>; there
may be hundreds of files changed by those commits, but <code>wez</code> only cares about the
work in their local branch of the DAG.</p><p>Now <code>wez</code> wants to rebase their work on master.  This would be done using
a command like <code>hg rebase -d master -s fa2e92</code>:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">| @  bbbbbb  wez</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| |  Add cats.cpp</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| |</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">| o  aaaaaa  wez</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|/   Add cat.jpg</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">o  fabf87  coworker     master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.  Amazing new feature</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.</span></div></code></pre></div><p>The crucial part of this is what happens to the working copy; assuming that we now land
on commit <code>bbbbbb</code>, Watchman will observe changes for all of the hundreds of files that
changed across the rebase and pass this information on to the tools that are subscribed
or are querying for this information.</p><p>If your tooling is source control aware then you can ask watchman to run since queries
in a mode where it will return you information about the merge base with <code>master</code> and
the minimized set of files that changed.</p><p>To enable this mode you issue a query using a new <em>fat clock</em> as the <code>since</code> parameter
for the query:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-bash codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ watchman -j </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;-</span><span class="token string" style="color:rgb(195, 232, 141)">EOT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">[&quot;query&quot;, &quot;/path/to/root&quot;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;since&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      &quot;scm&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">        &quot;mergebase-with&quot;: &quot;master&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;expression&quot;: [&quot;type&quot;, &quot;f&quot;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;fields&quot;: [&quot;name&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">EOT</span></div></code></pre></div><p>This particular <code>since</code> value starts with an unspecified clock value and requests that
watchman run the query in source control aware mode, using the symbolic name <code>master</code>
to compute the merge base for the commit graph.</p><p>If we look back to the illustrations above and rewind to the first scenario,
the results of this query will look something like this:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;clock&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       &quot;clock&quot;: &quot;c:123:123&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       &quot;scm&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;mergebase&quot;: &quot;f12345&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;mergebase-with&quot;: &quot;master&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;files&quot;: [&quot;cat.jpg&quot;, &quot;cats.cpp&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></code></pre></div><p>This result informs the client of the merge base with master (which happens to
be master itself) and the list of changes since that merge base.</p><p>To get the next incremental change the client feeds that clock value back in to its
next query.  Looking back to the second illustration above, if we were to run this query
after the running <code>hg pull</code> (note that this doesn&#x27;t change the working copy):</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-bash codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ watchman -j </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;-</span><span class="token string" style="color:rgb(195, 232, 141)">EOT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">[&quot;query&quot;, &quot;/path/to/root&quot;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;since&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">       &quot;clock&quot;: &quot;c:123:123&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">       &quot;scm&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">            &quot;mergebase&quot;: &quot;f12345&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">            &quot;mergebase-with&quot;: &quot;master&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">       }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;expression&quot;: [&quot;type&quot;, &quot;f&quot;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;fields&quot;: [&quot;name&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">EOT</span></div></code></pre></div><p>we&#x27;d get this result:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;clock&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       &quot;clock&quot;: &quot;c:123:124&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       &quot;scm&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;mergebase&quot;: &quot;f12345&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;mergebase-with&quot;: &quot;master&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;files&quot;: []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></code></pre></div><p>Note that the <code>files</code> list is empty because we didn&#x27;t change any files, and
note that one of the numeric portions of the clock string has changed.</p><p>Also note that the mergebase revision remains the same because we also didn&#x27;t
rebase the commit yet.</p><p>This is a little white lie: the reality is that some files did change in the
version control system, and with the expression we&#x27;re using we would see them,
but they are not part of the working copy so we&#x27;re omitting them for the clarity
of this example.</p><p>Now if we rebase and update to the rebased revision (taking us to the last of the
illustrations from above), we&#x27;d run this query, feeding in the clock from the last
query to get the correct incremental result:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-bash codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ watchman -j </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;-</span><span class="token string" style="color:rgb(195, 232, 141)">EOT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">[&quot;query&quot;, &quot;/path/to/root&quot;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;since&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">       &quot;clock&quot;: &quot;c:123:124&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">       &quot;scm&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">            &quot;mergebase&quot;: &quot;f12345&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">            &quot;mergebase-with&quot;: &quot;master&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">       }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;expression&quot;: [&quot;type&quot;, &quot;f&quot;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  &quot;fields&quot;: [&quot;name&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">}]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">EOT</span></div></code></pre></div><p>we&#x27;d get this result:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-undefined codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;clock&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       &quot;clock&quot;: &quot;c:123:125&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       &quot;scm&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;mergebase&quot;: &quot;fabf87&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;mergebase-with&quot;: &quot;master&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;files&quot;: [&quot;cat.jpg&quot;, &quot;cats.cpp&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></code></pre></div><p>Note that the mergebase reported in the clock has changed and note that the
list of files reported is just the two from our commit stack despite there
being hundreds of files that were physically updated on the disk.</p><p>Your client can now lookup some state based on the <code>fabf87</code> revision and
download it, and can then incrementally apply the computation for <code>cat.jpg</code> and
<code>cats.cpp</code> on top of that state.</p><p>If your client doesn&#x27;t know how to do this, then you shouldn&#x27;t use this
source control aware query mode!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="source-control-aware-subscriptions"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#source-control-aware-subscriptions" title="Direct link to heading">#</a>Source Control Aware Subscriptions</h2><p>You can also use the same source control awareness in your subscriptions.  This
is basically the same procedure as making queries above, but there are some
preconditions and things to note:</p><ul><li>Watchman needs the cooperation of the source control system to know when
it should defer events.  At the time of writing this is only possible when
using Mercurial with the <code>fsmonitor</code> extension enabled.</li><li>Source control aware subscriptions implicitly enable <code>defer_vcs</code> and
<code>defer:[&quot;hg.update&quot;]</code>.  As with the point above, this is to ensure that
you don&#x27;t get notified about files changing during the working copy update
operation; that would defeat the point of using source control awareness.</li></ul><p>To initiate a source control aware subscription:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-json codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;subscribe&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/path/to/root&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;mysubscriptionname&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;fields&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;name&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;since&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;scm&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;mergebase-with&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;master&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></code></pre></div><p>You&#x27;ll then receive subscription responses as files change; those responses
will contain <em>fat clock</em> values for the <code>since</code> and <code>clock</code> fields:</p><div class="mdxCodeBlock_iHAB"><pre class="prism-code language-json codeBlock_19pQ"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><code class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;subscription&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;mysubscriptionname&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;clock&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;clock&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;c:1234:125&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;scm&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;mergebase&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;fabf87&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;mergebase-with&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;master&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;since&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;clock&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;c:1234:123&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;scm&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;mergebase&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;f12345&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token property">&quot;mergebase-with&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;master&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;files&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cat.jpg&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cats.cpp&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;root&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;/path/to/root&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></code></pre></div><p>The <code>clock</code> field holds the value of the clock and the merge base as of the subscription
notification.</p><p>The <code>since</code> field holds the <em>fat clock</em> that was returned in the <code>clock</code> field from
the prior subscription update.  It is present as a convenience for you; you can compare
the <code>mergebase</code> fields between the two to determine that the merge base changed in
this update.  This is an important detail because more files in the working copy have
been physically changed than are reflected in the <code>files</code> list; your tooling will need
to so something appropriate to ensure that it computes a consistent and correct result.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="state-enter--state-leave"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#state-enter--state-leave" title="Direct link to heading">#</a><code>state-enter</code> &amp; <code>state-leave</code></h3><p>Source control aware subscriptions will always include a <em>fat clock</em> in their responses, however,
only the regular clock is provided in <code>state-enter</code> and <code>state-leave</code> notifications.
This is because computing the source control information is a non-trivial operation and
could increase latency.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/watchman/edit/master/website/docs/scm-query.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/watchman/docs/simple-query"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« Simple Pattern Syntax</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/watchman/docs/allof"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">allof »</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#source-control-aware-subscriptions" class="contents__link">Source Control Aware Subscriptions</a><ul><li><a href="#state-enter--state-leave" class="contents__link"><code>state-enter</code> &amp; <code>state-leave</code></a></li></ul></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1Wg7"><img class="footer__logo" alt="Facebook Open Source Logo" src="/watchman/img/oss_logo.png"></a></div><div>Copyright © 2020 Facebook, Inc. Built with Docusaurus.</div></div></div></footer>
</div>

<script src="/watchman/styles.edf81c23.js"></script>

<script src="/watchman/runtime~main.8249b1c8.js"></script>

<script src="/watchman/main.531fe527.js"></script>

<script src="/watchman/1.8e55109d.js"></script>

<script src="/watchman/2.474167d8.js"></script>

<script src="/watchman/70.1fbfc70e.js"></script>

<script src="/watchman/d6764f29.44a68f59.js"></script>

<script src="/watchman/17896441.abd54760.js"></script>

<script src="/watchman/20b3f033.7168216c.js"></script>


</body>
</html>