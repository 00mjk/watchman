<html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>watchman | A file watching service</title><meta name="viewport" content="width=device-width"><meta property="og:title" content="watchman | A file watching service"><meta property="og:type" content="website"><meta property="og:url" content="http:&#x2f;&#x2f;facebook.github.io&#x2f;watchman&#x2f;index.html"><meta property="og:image" content="http:&#x2f;&#x2f;facebook.github.io&#x2f;watchman&#x2f;favicon.png"><meta property="og:description" content="A file watching service"><link rel="shortcut icon" href="&#x2f;watchman&#x2f;img&#x2f;favicon.png"><link rel="stylesheet" href="&#x2f;watchman&#x2f;css&#x2f;watchman.css"><script type="text&#x2f;javascript" src="&#x2f;&#x2f;use.typekit.net&#x2f;vqa1hcx.js"></script><script type="text&#x2f;javascript">try{Typekit.load();}catch(e){}</script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="&#x2f;watchman&#x2f;">watchman</a><ul class="nav-site"><li><a href="&#x2f;watchman&#x2f;docs&#x2f;install.html" class="active">docs</a></li><li><a href="&#x2f;watchman&#x2f;support.html" class="">support</a></li><li><a href="http:&#x2f;&#x2f;github.com&#x2f;facebook&#x2f;watchman" class="">github</a></li></ul></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-section"><h3>Installation</h3><ul><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;install.html">Installation</a></li></ul></div><div class="nav-docs-section"><h3>Invocation</h3><ul><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cli-options.html">Command Line</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;config.html">Configuration Files</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;socket-interface.html">Socket Interface</a></li></ul></div><div class="nav-docs-section"><h3>Commands</h3><ul><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;clock.html">clock</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;find.html">find</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;get-config.html">get-config</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;get-sockname.html">get-sockname</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;log.html">log</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;log-level.html">log-level</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;query.html">query</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;shutdown-server.html">shutdown-server</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;since.html">since</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;subscribe.html">subscribe</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;trigger.html">trigger</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;trigger-del.html">trigger-del</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;trigger-list.html">trigger-list</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;unsubscribe.html">unsubscribe</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;version.html">version</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;watch.html">watch</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;watch-del.html">watch-del</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;watch-list.html">watch-list</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;cmd&#x2f;watch-project.html">watch-project</a></li></ul></div><div class="nav-docs-section"><h3>Queries</h3><ul><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;clockspec.html">Clockspec</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;file-query.html">File Queries</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;simple-query.html">Simple Pattern Syntax</a></li></ul></div><div class="nav-docs-section"><h3>Internals</h3><ul><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;bser.html">BSER Binary Protocol</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;casefolding.html">Case-Insensitivity</a></li><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;contributing.html">Contributing</a></li><li><a style="margin-left:0;" class="active" href="&#x2f;watchman&#x2f;docs&#x2f;cookies.html">Query Synchronization</a></li></ul></div><div class="nav-docs-section"><h3>Troubleshooting</h3><ul><li><a style="margin-left:0;" class="" href="&#x2f;watchman&#x2f;docs&#x2f;troubleshooting.html">Troubleshooting</a></li></ul></div></div><div class="inner-content"><h1>Query Synchronization</h1><div><p>A file system monitor needs to make sure that queries see up-to-date
views. Watchman ensures that by creating a unique <em>cookie</em> for each query made
to it.</p><h2><a class="anchor" name="background"></a>Background <a class="hash-link" href="#background">#</a></h2><p>Consider a directory tree traversal to gather file status, such as the one
performed by <code>hg status</code> or <code>git status</code>. The traversal will race with any
operations happening concurrently, and this is impossible to fix. However, we
do get some weaker guarantees:</p><ol><li>Every file operation that happens before the traversal is started will be
observed.</li><li>File operations that happen after the traversal is started may or may not be
observed.</li></ol><p>For watchman, cookies enable us to provide similar guarantees. For a given
watchman query:</p><ol><li>Every file operation that happens before the query is started will be
observed.</li><li>File operations that happen after the query is started may or may not be
observed.</li></ol><h2><a class="anchor" name="how-cookies-work"></a>How cookies work <a class="hash-link" href="#how-cookies-work">#</a></h2><p>A <em>cookie</em> is a temporary file that is created inside a directory observed by
watchman. The cookie is created in a directory that is expected not to go
away. The obvious location is the root itself, but we&#x27;d like cookies not to show
up in VCS operations. So if a VCS directory (<code>.git</code>, <code>.hg</code> or <code>.svn</code>) is found,
that&#x27;s where cookies are created instead.</p><p>The cookie is created while the root is locked, so watchman won&#x27;t find the
cookie by accident while processing events from a prior run.</p><p>Once the cookie is created, the calling thread waits on a condition variable
guarded by the root&#x27;s lock. This causes the lock to be released, and the root&#x27;s
notify thread can now read events as usual.</p><p>When the notify thread finds that it is processing a cookie, it will signal its
respective condition variable. Importantly, this does not wake the calling
thread up immediately: since the notify thread still holds the root lock, the
calling thread will only be able to proceed once the notify thread releases the
lock.</p><p><em>What do cookies get us?</em></p><p>File monitoring systems like <code>inotify</code> typically provide an ordering guarantee:
notifications arrive in the order they happen. Any events happening before the
cookie is created will appear before the event for the cookie does, which means
they will be processed by the time the query is answered.</p><p><em>How well do cookies work?</em></p><p>The Mercurial test suite has proved to be a good stress test for
watchman. Before cookies were implemented, if 16 or more tests from the suite
were run in parallel, watchman would start falling behind and often produce
outdated answers. Cookies have successfully eradicated that.</p><p><em>Can watchman find a cookie even if not all events leading to its appearance
 have been processed?</em></p><p>Consider this situation when cookies are created inside <code>.hg</code>:</p><ol><li>Event A happens that would cause <code>.hg</code> to be read recursively</li><li>Event B happens that touches a file <code>subdir&#x2f;foo</code></li><li>A cookie is created inside <code>.hg</code>, causing event C</li><li>Event A is read from the OS file notification system but not events B and C</li><li>The cookie is found but <code>subdir&#x2f;foo</code> is never read.</li></ol><p>On Linux, to prevent this from happening, watchman will only consider a cookie
to be found if it is directly returned via OS notifications. The only exception
to this is during the initial crawl or a recrawl, when the cookie directory
isn&#x27;t being watched yet.</p><p>On other platforms, this becomes more complicated because the respective
monitoring system only tells us that something inside a directory was created,
not what was created. This is currently an unresolved issue.</p><h2><a class="anchor" name="credits"></a>Credits <a class="hash-link" href="#credits">#</a></h2><p>The idea was originally proposed by Matt Mackall <a href="mailto:mpm@selenic.com">mpm@selenic.com</a>.</p></div><div class="docs-prevnext"></div></div></section><footer class="wrap"><div class="right">Â© 2012-2015 Facebook Inc.</div></footer></div><div id="fb-root"></div><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-387204-10', 'facebook.github.io');
            ga('send', 'pageview');

            !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)
            ){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";
            fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
          </script></body></html>