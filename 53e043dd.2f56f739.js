(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{159:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return o})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return l}));var a=n(1),r=(n(0),n(209));const i={id:"state-enter",title:"state-enter"},o={id:"state-enter",title:"state-enter",description:"_Since 4.4_",source:"@site/docs/state-enter.md",permalink:"/watchman/docs/state-enter",editUrl:"https://github.com/facebook/watchman/edit/master/website/docs/state-enter.md",sidebar:"sidebar",previous:{title:"since",permalink:"/watchman/docs/since"},next:{title:"state-leave",permalink:"/watchman/docs/state-leave"}},c=[{value:"Examples",id:"examples",children:[]},{value:"Synchronization",id:"synchronization",children:[]}],s={rightToc:c};function l({components:e,...t}){return Object(r.b)("wrapper",Object(a.a)({},s,t,{components:e,mdxType:"MDXLayout"}),Object(r.b)("p",null,Object(r.b)("em",{parentName:"p"},"Since 4.4")),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"state-enter")," command works in conjunction with ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"state-leave"}),"state-leave"),"\nto facilitate\n",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"subscribe#advanced-settling"}),"advanced settling in subscriptions"),"."),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"state-enter")," causes a watch to be marked as being in a particular named\nstate. The state is asserted until a corresponding ",Object(r.b)("inlineCode",{parentName:"p"},"state-leave")," command is\nissued or ",Object(r.b)("em",{parentName:"p"},"until the watchman client session that entered the state\ndisconnects"),". This automatic cleanup helps to avoid breaking subscribers if\nthe tooling that initiated a state terminates unexpectedly."),Object(r.b)("p",null,"Subscriptions can use the ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"subscribe#defer"}),"defer")," and ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"subscribe#drop"}),"drop"),"\nfields to defer or drop notifications generated while the watch is in a\nparticular named state."),Object(r.b)("h3",{id:"examples"},"Examples"),Object(r.b)("p",null,"This is the simplest example; entering a state named ",Object(r.b)("inlineCode",{parentName:"p"},"mystate"),":"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'["state-enter", "/path/to/root", "mystate"]\n')),Object(r.b)("p",null,"It will cause any subscribers to receive a unilateral subscription PDU from\nthe watchman server:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{\n  "subscription": "mysubscriptionname",\n  "root": "/path/to/root",\n  "state-enter": "mystate",\n  "clock": "c:1446410081:18462:7:127"\n}\n')),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"clock")," field in the response is the (synchronized; see below) clock at\nthe time that the state was entered and can be used in subsequent queries, in\ncombination with the corresponding ",Object(r.b)("inlineCode",{parentName:"p"},"state-leave")," subscription PDU clock, to\nlocate things that changed while the state was asserted."),Object(r.b)("p",null,"A more complex example demonstrates passing metadata to any subscribers. The\n",Object(r.b)("inlineCode",{parentName:"p"},"metadata")," field is propagated through to the subscribers and is not\ninterpreted by the watchman server. It can be any JSON value."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n  "state-enter",\n  "/path/to/root",\n  {\n    "name": "mystate",\n    "metadata": {\n      "foo": "bar"\n    }\n  }\n]\n')),Object(r.b)("p",null,"This will emit the following unilateral subscription PDU to all subscribers:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{\n  "subscription": "mysubscriptionname",\n  "root": "/path/to/root",\n  "state-enter": "mystate",\n  "clock": "c:1446410081:18462:7:137",\n  "metadata": {\n    "foo": "bar"\n  }\n}\n')),Object(r.b)("h3",{id:"synchronization"},"Synchronization"),Object(r.b)("p",null,"States are synchronized with the state of the filesystem so that it is\npossible for subscribers to reason about when files changed with respect to\nthe state."),Object(r.b)("p",null,"This means that issuing a ",Object(r.b)("inlineCode",{parentName:"p"},"state-enter")," command will\n",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"cookies#how-cookies-work"}),"perform query synchronization")," to ensure that\nthings are in sync."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"state-enter")," command will use a default ",Object(r.b)("inlineCode",{parentName:"p"},"sync_timeout")," of 60 seconds. If\nthe synchronization cookie is not observed within the configured\n",Object(r.b)("inlineCode",{parentName:"p"},"sync_timeout"),", an error will be returned and ",Object(r.b)("em",{parentName:"p"},"the state will not be entered"),"."),Object(r.b)("p",null,"In some cases, perhaps during the initial crawl of a very large tree, You may\nspecify an alternative value for the timeout; the value is expressed in\n",Object(r.b)("em",{parentName:"p"},"milliseconds"),":"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'[\n  "state-enter",\n  "/path/to/root",\n  {\n    "name": "mystate",\n    "sync_timeout": 10000,\n    "metadata": {\n      "foo": "bar"\n    }\n  }\n]\n')),Object(r.b)("p",null,"You may also specify ",Object(r.b)("inlineCode",{parentName:"p"},"0")," for the timeout to disable synchronization for this\nparticular command. This may cause the state to appear to clients to have been\nentered logically before it actually did in the case that there are buffered\nnotifications that have not yet been processed by watchman at the time that\nthe state was entered."))}l.isMDXComponent=!0},209:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return d}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),b=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c({},t,{},e)),n},p=function(e){var t=b(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),p=b(n),m=a,d=p["".concat(o,".").concat(m)]||p[m]||u[m]||i;return n?r.a.createElement(d,c({ref:t},l,{components:n})):r.a.createElement(d,c({ref:t},l))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var l=2;l<i;l++)o[l]=n[l];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);